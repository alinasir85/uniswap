name: Merge develop to test-mode

on:
  push:
    branches:
      - 'develop'

jobs:
  merge-branches:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR target branch
        id: check_target_branch
        run: echo "CHECK_TARGET_BRANCH=${{ github.ref }}" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Fetch all branches
        run: git fetch --all
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge to Test Mode
        if: ${{ env.CHECK_TARGET_BRANCH == 'refs/heads/develop' }}
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          # Create a PR using the GitHub API
          PR_URL=$(curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{
              "title": "Merge develop into test-mode",
              "head": "develop",
              "base": "test-mode"
            }' \
            "https://api.github.com/repos/${{ github.repository }}/pulls" | jq -r '.html_url')

          echo "Created PR: $PR_URL"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: $PR_URL

      - name: Automatically merge the PR
        if: ${{ env.CHECK_TARGET_BRANCH == 'refs/heads/develop' }}
        run: |
          # Extract PR URL from environment
          PR_URL="${{ env.PR_URL }}"

          # Use a Personal Access Token (PAT) to merge the PR
          curl -X PUT \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -d '{
              "commit_title": "Merge pull request",
              "merge_method": "merge"
            }' \
            "$PR_URL/merge"

        env:
          GH_PAT: ${{ secrets.GH_PAT }}